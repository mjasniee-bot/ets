<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<title>KTMB Command Center Level 4 Professional</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>

body{
margin:0;
background:#020617;
color:white;
font-family:Segoe UI,Arial;
}

#map{
height:100vh;
}

.panel{
position:absolute;
top:15px;
left:15px;
background:rgba(15,23,42,0.95);
padding:18px;
border-radius:12px;
box-shadow:0 0 25px rgba(0,255,255,0.4);
z-index:999;
width:260px;
}

.title{
font-size:18px;
color:#00ffff;
margin-bottom:8px;
}

.stat{
font-size:14px;
margin-top:4px;
}

.big{
font-size:28px;
color:#00ffff;
}

.active{
color:#00ff88;
}

.stopped{
color:#ff4d4d;
}

.lastupdate{
font-size:12px;
color:#94a3b8;
margin-top:6px;
}

.train-label{
font-size:12px;
font-weight:bold;
color:white;
text-shadow:0 0 6px black;
}

.dot{
width:12px;
height:12px;
border-radius:50%;
}

.dot-active{
background:#00ff88;
box-shadow:0 0 10px #00ff88;
}

.dot-stopped{
background:#ff4d4d;
box-shadow:0 0 10px #ff4d4d;
}

</style>

</head>

<body>

<div id="map"></div>

<div class="panel">

<div class="title">KTMB Command Center</div>

<div class="big" id="total">0</div>

<div class="stat active">
Active: <span id="activeCount">0</span>
</div>

<div class="stat stopped">
Stopped / Offline: <span id="stoppedCount">0</span>
</div>

<div class="stat" id="systemStatus">
System: Connecting...
</div>

<div class="lastupdate" id="lastUpdate">
Last update: -
</div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

const map = L.map('map').setView([4.5,102],7);

L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
{maxZoom:19}
).addTo(map);

let markers = {};

function createDot(active){

const className = active ? "dot dot-active" : "dot dot-stopped";

return L.divIcon({

html:`<div class="${className}"></div>`,
iconSize:[12,12]

});

}

function isActive(speed,timestamp){

const now = Date.now()/1000;
const age = now - timestamp;

return speed > 1 && age < 120;

}

async function loadTrains(){

document.getElementById("systemStatus").innerText="System: Updating...";

try{

const res = await fetch("/api/ktmb");
const data = await res.json();

let activeCount=0;
let stoppedCount=0;

data.entity.forEach(train=>{

const id = train.id;

const lat = train.vehicle.position.latitude;
const lon = train.vehicle.position.longitude;
const speed = train.vehicle.position.speed || 0;
const timestamp = parseInt(train.vehicle.timestamp);

const label = train.vehicle.vehicle.label;

const active = isActive(speed,timestamp);

if(active) activeCount++;
else stoppedCount++;

if(!markers[id]){

const marker = L.marker(
[lat,lon],
{icon:createDot(active)}
).addTo(map);

marker.bindTooltip(label,{
permanent:true,
direction:"top",
className:"train-label"
});

marker.on("click",()=>{

marker.bindPopup(
"<b>"+label+"</b><br>"+
"Speed: "+speed+" km/h<br>"+
"Lat: "+lat.toFixed(5)+"<br>"+
"Lon: "+lon.toFixed(5)+"<br>"+
"Status: "+(active?"ACTIVE":"STOPPED")
).openPopup();

});

markers[id]=marker;

}else{

markers[id].setLatLng([lat,lon]);
markers[id].setIcon(createDot(active));

}

});

document.getElementById("total").innerText =
activeCount+stoppedCount;

document.getElementById("activeCount").innerText =
activeCount;

document.getElementById("stoppedCount").innerText =
stoppedCount;

document.getElementById("systemStatus").innerText =
"System: LIVE";

document.getElementById("lastUpdate").innerText =
"Last update: "+new Date().toLocaleTimeString();

}catch(e){

document.getElementById("systemStatus").innerText =
"System: ERROR";

}

}

loadTrains();

setInterval(loadTrains,5000);

</script>

</body>
</html>
