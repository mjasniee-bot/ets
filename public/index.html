<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<title>KTMB Command Center</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>

body{
margin:0;
background:#0b1220;
color:white;
font-family:Segoe UI, Arial;
}

#map{
height:100vh;
}

.panel{

position:absolute;
top:15px;
left:15px;
background:#0f172a;
padding:15px;
border-radius:10px;
box-shadow:0 0 20px rgba(0,255,255,0.4);
z-index:999;
min-width:240px;

}

.title{

font-size:18px;
margin-bottom:10px;
color:#00ffff;

}

.counter{

font-size:32px;
color:#00ffff;

}

.status{

margin-top:5px;
font-size:14px;

}

.lastupdate{

font-size:12px;
color:#94a3b8;

}

.filter{

margin-top:10px;

}

button{

background:#1e293b;
color:white;
border:none;
padding:6px 12px;
margin-right:5px;
cursor:pointer;
border-radius:6px;

}

button.active{

background:#00ffff;
color:black;

}

.train-label{

font-size:11px;
color:white;
font-weight:bold;
text-shadow:0 0 5px black;

}

.blink{

animation:blink 1s infinite;

}

@keyframes blink{

0%{opacity:1;}
50%{opacity:0.3;}
100%{opacity:1;}

}

</style>

</head>

<body>

<div id="map"></div>

<div class="panel">

<div class="title">KTMB Command Center</div>

<div class="counter" id="count">0</div>

<div class="status" id="status">Connecting...</div>

<div class="lastupdate" id="lastupdate"></div>

<div class="filter">

<button onclick="setFilter('ALL')" id="btnALL" class="active">ALL</button> <button onclick="setFilter('ETS')" id="btnETS">ETS</button> <button onclick="setFilter('KOMUTER')" id="btnKOMUTER">Komuter</button>

</div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

const map = L.map('map').setView([4.5,102],7);

L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
{maxZoom:19}
).addTo(map);

let markers=[];
let filter="ALL";

function setFilter(type){

filter=type;

document.querySelectorAll("button")
.forEach(btn=>btn.classList.remove("active"));

document.getElementById("btn"+type)
.classList.add("active");

load();

}

function getType(label){

if(label.includes("EMU") || label.includes("ETS"))
return "ETS";

return "KOMUTER";

}

function createMarker(train){

const lat=train.vehicle.position.latitude;
const lon=train.vehicle.position.longitude;
const speed=train.vehicle.position.speed || 0;
const label=train.vehicle.vehicle.label;

const type=getType(label);

if(filter!="ALL" && type!=filter)
return null;

const color = type=="ETS" ? "#00ffff" : "#00ff00";

const marker = L.circleMarker([lat,lon],{

radius:8,
color:color,
fillColor:color,
fillOpacity:1,
className:"blink"

}).addTo(map);

marker.bindPopup(

"<b>"+label+"</b><br>"+
"Type: "+type+"<br>"+
"Speed: "+speed+" km/h<br>"+
"Lat: "+lat.toFixed(5)+"<br>"+
"Lon: "+lon.toFixed(5)

);

marker.bindTooltip(label,{
permanent:true,
direction:"top",
className:"train-label"
});

return marker;

}

async function load(){

document.getElementById("status").innerText="Updating...";

markers.forEach(m=>map.removeLayer(m));
markers=[];

try{

const res = await fetch("/api/ktmb");
const data = await res.json();

let count=0;

data.entity.forEach(train=>{

const marker=createMarker(train);

if(marker){

markers.push(marker);
count++;

}

});

document.getElementById("count").innerText=count;
document.getElementById("status").innerText="LIVE";
document.getElementById("lastupdate").innerText=
"Last update: "+new Date().toLocaleTimeString();

}catch(e){

document.getElementById("status").innerText="ERROR";

}

}

load();

setInterval(load,5000);

</script>

</body>
</html>
