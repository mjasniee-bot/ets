<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KTMB Command Center</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{
    margin:0;
    background:#0b0f1a;
    color:#00ffc3;
    font-family:Segoe UI;
}

#map{
    height:100vh;
}

.panel{
    position:absolute;
    top:20px;
    left:20px;
    background:rgba(0,0,0,0.8);
    padding:15px;
    border-radius:10px;
    box-shadow:0 0 20px #00ffc3;
}

.title{
    font-size:20px;
    font-weight:bold;
}

.stat{
    margin-top:5px;
    font-size:14px;
}
</style>
</head>

<body>

<div class="panel">
<div class="title">ðŸ›° KTMB Command Center</div>
<div class="stat">ðŸš† Active trains: <span id="count">0</span></div>
<div class="stat">ðŸ•’ Last update: <span id="time">--</span></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

const map = L.map('map').setView([4.5,102],7);

L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
).addTo(map);

const trainIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/685/685352.png',
    iconSize:[32,32]
});

let markers = {};

async function loadTrains(){

    const res = await fetch('/api/ktmb');
    const data = await res.json();

    document.getElementById("count").innerText =
        data.entity.length;

    document.getElementById("time").innerText =
        new Date().toLocaleTimeString();

    data.entity.forEach(train=>{

        if(!train.vehicle) return;

        const lat = train.vehicle.position.latitude;
        const lon = train.vehicle.position.longitude;
        const id = train.vehicle.vehicle.label;

        if(markers[id]){

            markers[id].setLatLng([lat,lon]);

        }else{

            markers[id] = L.marker([lat,lon],{
                icon:trainIcon
            }).addTo(map)
            .bindTooltip(
                "ðŸš† "+id,
                {permanent:true}
            );

        }

    });

}

loadTrains();
setInterval(loadTrains,5000);

</script>

</body>
</html>
