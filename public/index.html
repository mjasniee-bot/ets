<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>

<title>KTMB Command Center Level 5</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>

body{
margin:0;
background:#020617;
color:white;
font-family:Segoe UI,Arial;
}

#map{
height:100vh;
}

.panel{

position:absolute;
top:15px;
left:15px;
background:rgba(15,23,42,0.95);
padding:18px;
border-radius:12px;
box-shadow:0 0 25px rgba(0,255,255,0.5);
z-index:999;
width:260px;

}

.title{
font-size:18px;
color:#00ffff;
margin-bottom:8px;
}

.counter{
font-size:34px;
color:#00ffff;
}

.status{
font-size:14px;
margin-top:4px;
}

.lastupdate{
font-size:12px;
color:#94a3b8;
margin-top:2px;
}

.filter{
margin-top:12px;
}

button{

background:#0f172a;
color:white;
border:1px solid #334155;
padding:6px 12px;
margin-right:4px;
border-radius:6px;
cursor:pointer;

}

button.active{

background:#00ffff;
color:black;

}

.train-label{

font-size:12px;
font-weight:bold;
color:white;
text-shadow:0 0 6px black;

}

.blink{

animation:blink 1s infinite;

}

@keyframes blink{

0%{opacity:1;}
50%{opacity:0.3;}
100%{opacity:1;}

}

</style>

</head>

<body>

<div id="map"></div>

<div class="panel">

<div class="title">KTMB Command Center</div>

<div class="counter" id="count">0</div>

<div class="status" id="status">Connecting...</div>

<div class="lastupdate" id="lastupdate"></div>

<div class="filter">

<button onclick="setFilter('ALL')" id="btnALL" class="active">ALL</button> <button onclick="setFilter('ETS')" id="btnETS">ETS</button> <button onclick="setFilter('KOMUTER')" id="btnKOMUTER">Komuter</button>

</div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

const map = L.map('map',{zoomControl:true})
.setView([4.5,102],7);

L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
{maxZoom:19}
).addTo(map);

let trains={}
let filter="ALL"

function setFilter(type){

filter=type

document.querySelectorAll("button")
.forEach(b=>b.classList.remove("active"))

document.getElementById("btn"+type)
.classList.add("active")

refresh()

}

function getType(label){

if(label.includes("EMU")||label.includes("ETS"))
return "ETS"

return "KOMUTER"

}

function createIcon(type){

const color = type=="ETS"?"#00ffff":"#00ff00"

return L.divIcon({

html:`
<div class="blink"
style="
width:12px;
height:12px;
background:${color};
border-radius:50%;
box-shadow:0 0 10px ${color};
">
</div>
`,

iconSize:[12,12]

})

}

function updateTrain(id,data){

const lat=data.vehicle.position.latitude
const lon=data.vehicle.position.longitude
const speed=data.vehicle.position.speed||0
const label=data.vehicle.vehicle.label
const type=getType(label)

if(filter!="ALL" && type!=filter){

if(trains[id]){
map.removeLayer(trains[id].marker)
delete trains[id]
}

return
}

if(!trains[id]){

const marker=L.marker([lat,lon],{
icon:createIcon(type)
}).addTo(map)

marker.bindTooltip(label,{
permanent:true,
direction:"top",
className:"train-label"
})

marker.bindPopup(

"<b>"+label+"</b><br>"+
"Type: "+type+"<br>"+
"Speed: "+speed+" km/h<br>"+
"Lat: "+lat.toFixed(5)+"<br>"+
"Lon: "+lon.toFixed(5)

)

trains[id]={marker}

}else{

// smooth move animation
trains[id].marker.setLatLng([lat,lon])

}

}

async function refresh(){

document.getElementById("status").innerText="Updating..."

try{

const res=await fetch("/api/ktmb")
const data=await res.json()

let count=0

data.entity.forEach(train=>{

updateTrain(train.id,train)

if(filter=="ALL" || getType(train.vehicle.vehicle.label)==filter)
count++

})

document.getElementById("count").innerText=count
document.getElementById("status").innerText="LIVE"
document.getElementById("lastupdate").innerText=
"Last update: "+new Date().toLocaleTimeString()

}catch(e){

document.getElementById("status").innerText="ERROR"

}

}

refresh()

setInterval(refresh,4000)

</script>

</body>
</html>
