<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KTMB Command Center v3</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>

body{
margin:0;
background:#050a14;
color:#00ffe1;
font-family:Consolas,Segoe UI;
overflow:hidden;
}

#map{
height:100vh;
}

.panel{
position:absolute;
top:0;
left:0;
width:320px;
height:100%;
background:rgba(0,0,0,0.85);
padding:20px;
box-shadow:0 0 30px #00ffe1;
z-index:999;
}

.title{
font-size:22px;
margin-bottom:20px;
}

.stat{
margin:10px 0;
}

.button{
margin-top:10px;
padding:8px;
background:#00ffe1;
color:black;
cursor:pointer;
text-align:center;
border-radius:5px;
}

.telemetry{
margin-top:20px;
font-size:13px;
line-height:1.6;
}

.blink{
animation: blink 1s infinite;
}

@keyframes blink{
0%{opacity:1;}
50%{opacity:0.3;}
100%{opacity:1;}
}

</style>
</head>

<body>

<div class="panel">

<div class="title">ðŸ›° KTMB COMMAND CENTER</div>

<div class="stat">Active trains: <span id="count">0</span></div>
<div class="stat">System time: <span id="time">--</span></div>

<div class="button" onclick="centerMap()">CENTER MALAYSIA</div>
<div class="button" onclick="loadTrains()">REFRESH NOW</div>

<div class="telemetry" id="telemetry">
Click train to view telemetry
</div>

</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

const map = L.map('map').setView([4.5,102],7);

const normalLayer = L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
);

const satelliteLayer = L.tileLayer(
'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
);

satelliteLayer.addTo(map);

const trainIcon = L.icon({
iconUrl:'https://cdn-icons-png.flaticon.com/512/685/685352.png',
iconSize:[35,35]
});

let markers={};

function centerMap(){

map.setView([4.5,102],7);

}

async function loadTrains(){

const res = await fetch('/api/ktmb');
const data = await res.json();

document.getElementById("count").innerText=data.entity.length;
document.getElementById("time").innerText=new Date().toLocaleTimeString();

data.entity.forEach(train=>{

if(!train.vehicle) return;

const lat=train.vehicle.position.latitude;
const lon=train.vehicle.position.longitude;

const id=train.vehicle.vehicle.label;
const speed=train.vehicle.position.speed;
const trip=train.vehicle.trip.tripId;

if(markers[id]){

markers[id].setLatLng([lat,lon]);

}else{

const marker=L.marker([lat,lon],{icon:trainIcon})
.addTo(map)
.bindTooltip("ðŸš† "+id,{permanent:true});

marker.on("click",()=>{

document.getElementById("telemetry").innerHTML=
`
<b>Train:</b> ${id}<br>
<b>Trip:</b> ${trip}<br>
<b>Speed:</b> ${speed} km/h<br>
<b>Lat:</b> ${lat.toFixed(5)}<br>
<b>Lon:</b> ${lon.toFixed(5)}<br>
<b>Status:</b> ACTIVE
`;

});

markers[id]=marker;

}

});

}

loadTrains();

setInterval(loadTrains,4000);

</script>

</body>
</html>
